name: Coverage summary

on:
  push:
    branches: [main]
  pull_request:

permissions:
  pull-requests: write # for commenting on PR
  contents: write # for adding the badges to the covr2gh-storage branch

jobs:
  covr2gh-on-pr:
    name: Assess coverage & post comment
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      BADGE_BRANCH: ${{ github.head_ref }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
            dragosmg/covr2gh
          needs: coverage

      - name: Calculate head coverage & make badge
        run: |
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          pkg_path <- file.path(temp_path, "package_head")
          head_cov_path <- file.path(temp_path, "head_cov.RDS")
          badge_path <- file.path(temp_path, "coverage_badge.svg")

          head_cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = pkg_path
          )

          saveRDS(head_cov, head_cov_path)

          coverage_badge <- head_cov |>
            covr::percent_coverage() |>
            covr2gh::generate_badge()

          writeLines(coverage_badge, badge_path)
        shell: Rscript {0}

      - name: Upload coverage result for head
        uses: actions/upload-artifact@v6
        with:
          name: head_coverage
          path: ${{ runner.temp }}/head_cov.RDS
          retention-days: 5

      - name: Configure git identity
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

      - name: Attach storage worktree (orphan if missing)
        run: |
          ORIGINAL_REF="${GITHUB_REF_NAME}"

          git fetch origin covr2gh-storage || true

          if git show-ref --verify --quiet refs/remotes/origin/covr2gh-storage; then
            echo "Storage branch exists"
            git worktree add storage covr2gh-storage
          else
            echo "Creating orphan storage branch"

            # Create orphan branch in main repo
            git checkout --orphan covr2gh-storage
            git reset --hard

            mkdir -p badges
            echo "# Coverage badges" > README.md

            git add .
            git commit -m "Initialize covr2gh-storage branch"
            git push origin covr2gh-storage

            # Switch back to original branch
            git checkout "$ORIGINAL_REF"

            # Attach worktree
            git worktree add storage covr2gh-storage
          fi

      - name: Commit badge
        working-directory: storage
        run: |
          mkdir -p "badges/$BADGE_BRANCH"
          cp "$RUNNER_TEMP/coverage_badge.svg" \
              "badges/$BADGE_BRANCH/coverage_badge.svg"

          git add badges
          git commit -m "Update badge for $BADGE_BRANCH ($GITHUB_SHA)" || true

          if ! git push origin covr2gh-storage; then
            echo "Push rejected (likely branch protection); skipping"
            exit 0
          fi


      # - name: Commit badge
      #   working-directory: badges
      #   run: |
      #     # already on the covr2gh-storage branch
      #     # so no need for checkout

      #     mkdir -p "${{ github.head_ref }}"
      #     cp "$RUNNER_TEMP/coverage_badge.svg" "${{ github.head_ref }}/coverage_badge.svg"

      #     git add "${{ github.head_ref }}/coverage_badge.svg"

      #     git commit -m "Add/Update badge: ${{ github.sha }}" || true
      #     git push
      #   shell: bash

      # - name: Checkout base / target branch
      #   uses: actions/checkout@v6
      #   with:
      #     ref: ${{ github.base_ref }}

      - name: Attach base branch worktree
        run: |
          git fetch origin "${{ github.base_ref }}"
          git worktree add base "${{ github.base_ref }}"

      - name: Re-install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
            dragosmg/covr2gh
          needs: coverage

      - name: Calculate base coverage
        working-directory: base
        run: |
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          pkg_path <- file.path(temp_path, "package_base")
          base_cov_path <- file.path(temp_path, "base_cov.RDS")

          base_cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = pkg_path
          )

          saveRDS(base_cov, base_cov_path)
        shell: Rscript {0}

      - name: Upload coverage result for base
        uses: actions/upload-artifact@v6
        with:
          name: base_coverage
          path: ${{ runner.temp }}/base_cov.RDS
          retention-days: 5

      - name: Post coverage comment
        run: |
          # paths
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          head_cov_path <- file.path(temp_path, "head_cov.RDS")
          base_cov_path <- file.path(temp_path, "base_cov.RDS")
          comment_path <- file.path(temp_path, "comment.md")

          head_coverage <- readRDS(head_cov_path)
          base_coverage <- readRDS(base_cov_path)

          comment <- covr2gh::compose_comment(
            head_coverage = head_coverage,
            base_coverage = base_coverage,
            repo = "${{ github.repository }}",
            pr_number = ${{ github.event.pull_request.number }}
          )

          covr2gh::post_comment(
            comment,
            repo = "${{ github.repository }}",
            pr_number = ${{ github.event.pull_request.number }}
          )

          writeLines(comment, comment_path)
        shell: Rscript {0}

      - name: Cleanup worktrees
        if: always()
        run: |
          echo "Cleaning up git worktrees"

          # Remove storage worktree if it exists
          if [ -d storage ]; then
            git worktree remove storage --force
          fi

          # Remove base worktree if it exists
          if [ -d base ]; then
            git worktree remove base --force
          fi

          # Prune stale worktree metadata
          git worktree prune

      - name: Job summary
        run: |
          cat "$RUNNER_TEMP/comment.md" >> $GITHUB_STEP_SUMMARY

  covr2gh-on-push:
    name: Coverage & badge for main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      BADGE_BRANCH: ${{ github.ref_name }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
            dragosmg/covr2gh
          needs: coverage

      - name: Calculate coverage & make badge
        run: |
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          pkg_path <- file.path(temp_path, "package_base")
          badge_path <- file.path(temp_path, "coverage_badge.svg")

          main_cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = pkg_path
          )

          main_cov_badge <- main_cov |>
            covr::percent_coverage() |>
            covr2gh::generate_badge()

          writeLines(main_cov_badge, badge_path)
        shell: Rscript {0}

      - name: Configure git identity
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

      - name: Initialise / switch branch
        run: |
          git fetch origin covr2gh-storage || true
          git switch covr2gh-storage || git checkout --orphan covr2gh-storage
          git pull --rebase origin covr2gh-storage || true

          # Ensure that the bare minimum components exist in the branch
          mkdir -p badges
          touch README.md badges/.gitkeep

          # Copy necessary files and folders to a temporary location
          mkdir -p /tmp/${{ github.sha }}
          echo "Copying badges/ to /tmp/${{ github.sha }}"
          cp -r .git README.md badges /tmp/${{ github.sha }}

          # Remove everything else
          # Attribution: https://unix.stackexchange.com/a/77313
          rm -rf ..?* .[!.]* *

          # Restore files from the temporary location
          echo "Copying badges/ from /tmp/${{ github.sha }}"
          cp -r /tmp/${{ github.sha }}/.git /tmp/${{ github.sha }}/README.md /tmp/${{ github.sha }}/badges .
          rm -rf /tmp/${{ github.sha }}
          git add --all -f
          git commit -m "Update storage branch: $( + '%Y-%m-%d %H:%M')" || true
          git push -u origin covr2gh-storage
        shell: bash

      - name: Commit badge
        working-directory: badges
        run: |
          # already on the covr2gh-storage branch
          # so no need for checkout

          mkdir -p "${{ github.ref_name }}"
          cp "$RUNNER_TEMP/coverage_badge.svg" "${{ github.ref_name }}/coverage_badge.svg"

          git add "${{ github.ref_name }}/coverage_badge.svg"

          git commit -m "Add/Update badge: ${{ github.sha }}" || true
          git push
        shell: bash
