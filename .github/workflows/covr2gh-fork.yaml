name: Coverage summary

on: workflow_dispatch

permissions:
  pull-requests: write
  contents: write

jobs:
  covr2gh:
    name: Coverage & badge
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      BADGE_BRANCH: ${{ github.head_ref || github.ref_name }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::covr
            dragosmg/covr2gh
          needs: coverage

      - name: Head coverage & badge
        run: |
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          pkg_path <- file.path(temp_path, "package_head")
          head_cov_path <- file.path(temp_path, "head_cov.RDS")
          badge_path <- file.path(temp_path, "coverage_badge.svg")

          head_cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = pkg_path
          )

          saveRDS(head_cov, head_cov_path)

          badge <- head_cov |>
            covr::percent_coverage() |>
            covr2gh::generate_badge()
          writeLines(badge, badge_path)
        shell: Rscript {0}

      - name: Upload coverage badge & data (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: coverage-artifacts
          path: |
            ${{ runner.temp }}/coverage_badge.svg
            ${{ runner.temp }}/head_cov.RDS

      - name: Configure git identity
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"

      - name: Attach base branch worktree (PR only)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin "${{ github.base_ref }}"
          git worktree add base "${{ github.base_ref }}"

      - name: Calculate base coverage (PR only)
        if: github.event_name == 'pull_request'
        working-directory: base
        run: |
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")
          pkg_path <- file.path(temp_path, "package_base")
          base_cov_path <- file.path(temp_path, "base_cov.RDS")

          base_cov <- covr::package_coverage(
            quiet = FALSE,
            clean = FALSE,
            install_path = pkg_path
          )

          saveRDS(base_cov, base_cov_path)
        shell: Rscript {0}

      - name: Post coverage comment (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # paths
          temp_path <- normalizePath(Sys.getenv("RUNNER_TEMP"), winslash = "/")

          head_coverage <- readRDS(file.path(temp_path, "head_cov.RDS"))
          base_coverage <- readRDS(file.path(temp_path, "base_cov.RDS"))

          comment <- covr2gh::compose_comment(
            head_coverage = head_coverage,
            base_coverage = base_coverage,
            repo = "${{ github.repository }}",
            pr_number = ${{ github.event.pull_request.number }}
          )

          covr2gh::post_comment(
            comment,
            repo = "${{ github.repository }}",
            pr_number = ${{ github.event.pull_request.number }}
          )

          writeLines(comment, file.path(temp_path, "comment.md"))

          # # Construct artifact URL for the badge (example)
          # run_id <- Sys.getenv("GITHUB_RUN_ID")
          # owner_repo <- Sys.getenv("GITHUB_REPOSITORY")
          # badge_url <- paste0(
          #   "https://github.com/", owner_repo,
          #   "/suites/", run_id, "/artifacts/coverage-artifacts/coverage_badge.svg"
          # )

          #   comment <- covr2gh::compose_comment(
          #     head_coverage = head_cov,
          #     base_coverage = base_cov,
          #     repo = owner_repo,
          #     pr_number = Sys.getenv("PR_NUMBER"),
          #     badge_url = badge_url
          #   )

          #   covr2gh::post_comment(comment, repo = owner_repo,
          #                         pr_number = Sys.getenv("PR_NUMBER"))
            # writeLines(comment, file.path(temp_path, "comment.md"))
        shell: Rscript {0}

      - name: Commit badge to badges branch
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git fetch origin badges || true
          git checkout -B badges origin/badges || git checkout --orphan badges
          mkdir -p badges
          cp "$RUNNER_TEMP/coverage_badge.svg" badges/coverage_badge.svg
          git add badges/coverage_badge.svg
          git commit -m "Update coverage badge: $GITHUB_SHA" || true
          git push origin badges

      - name: Cleanup worktrees
        if: always()
        run: |
          git worktree remove base --force || true
          git worktree prune || true

      - name: Job summary
        if: github.event_name == 'pull_request'
        run: |
          cat "$RUNNER_TEMP/comment.md" >> $GITHUB_STEP_SUMMARY
